{"version":3,"sources":["../src/modal_view_video.js"],"names":["define","$","Notification","CustomEvents","Modal","ModalRegistry","Templates","Ajax","ModalEvents","registered","SELECTORS","ANALYZE_BUTTON","MAJOR_FLAG","MINOR_FLAG","CLEAR_FLAG","ModalVideo","root","attemptID","webroot","spinner","call","getFooter","find","length","exception","message","TYPE","prototype","Object","create","constructor","addViolations","severity","style","display","promises","methodname","args","attemptid","done","location","reload","fail","ex","registerEventListeners","getModal","on","events","activate","bind","show","player","document","getElementById","src","getRoot","hidden","pause","setAttemptID","id","setWebroot","register"],"mappings":"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","sourcesContent":["define(\r\n    [\r\n        'jquery',\r\n        'core/notification',\r\n        'core/custom_interaction_events',\r\n        'core/modal',\r\n        'core/modal_registry',\r\n        'core/templates',\r\n        'core/ajax',\r\n        'core/modal_events'\r\n    ],\r\nfunction (\r\n    $,\r\n    Notification,\r\n    CustomEvents,\r\n    Modal,\r\n    ModalRegistry,\r\n    Templates,\r\n    Ajax,\r\n    ModalEvents\r\n) {\r\n\r\n    var registered = false;\r\n    var SELECTORS = {\r\n        ANALYZE_BUTTON: '[data-action=\"analyze\"]',\r\n        MAJOR_FLAG: '[data-action=\"flagmajor\"]',\r\n        MINOR_FLAG: '[data-action=\"flagminor\"]',\r\n        CLEAR_FLAG: '[data-action=\"clear\"]'\r\n    };\r\n\r\n    /**\r\n     * Constructor for the Modal.\r\n     *\r\n     * @param {object} root The root jQuery element for the modal\r\n     */\r\n    var ModalVideo = function (root) {\r\n        this.attemptID = null;\r\n        this.webroot = null;\r\n        this.spinner = null;\r\n        Modal.call(this, root);\r\n\r\n        if (!this.getFooter().find(SELECTORS.ANALYZE_BUTTON).length) {\r\n            Notification.exception({ message: 'No analyze button found' });\r\n        }\r\n        if (!this.getFooter().find(SELECTORS.MAJOR_FLAG).length) {\r\n            Notification.exception({ message: 'No major flag button found' });\r\n        }\r\n        if (!this.getFooter().find(SELECTORS.MINOR_FLAG).length) {\r\n            Notification.exception({ message: 'No minor flag button found' });\r\n        }\r\n        if (!this.getFooter().find(SELECTORS.CLEAR_FLAG).length) {\r\n            Notification.exception({ message: 'No clear button found' });\r\n        }\r\n    };\r\n\r\n    ModalVideo.TYPE = 'mod_quiz-view_video';\r\n    ModalVideo.prototype = Object.create(Modal.prototype);\r\n    ModalVideo.prototype.constructor = ModalVideo;\r\n\r\n    /**\r\n     * Make an AJAX request to increase/decrease violation severity on attempt\r\n     * \r\n     * @param {int} severity severity of violation to add (negative to reduce)\r\n     */\r\n    ModalVideo.prototype.addViolations = function(severity) {\r\n        let spinner = this.spinner;\r\n        spinner.style.display = \"block\";\r\n        var promises = Ajax.call([\r\n            { methodname: 'mod_quiz_record_proctoring_violation', args: { attemptid: this.attemptID, severity: severity } },\r\n        ]);\r\n\r\n        promises[0].done(function (response) {\r\n            spinner.style.display = \"none\";\r\n            location.reload();\r\n        }).fail(function (ex) {\r\n            Notification.exception({ message: ex });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Set up all of the event handling for the modal.\r\n     *\r\n     * @method registerEventListeners\r\n     */\r\n    ModalVideo.prototype.registerEventListeners = function () {\r\n        // Apply parent event listeners.\r\n        Modal.prototype.registerEventListeners.call(this);\r\n\r\n        this.getModal().on(CustomEvents.events.activate, SELECTORS.ANALYZE_BUTTON, function (e, data) {\r\n            // Send video to API for analysis then call the violation bus via ajax with results\r\n            var videoURL = this.webroot + '/mod/quiz/serveproctorvideo.php?attemptid=' + this.attemptID;\r\n\r\n            // Some API call and record the response\r\n\r\n            // Take the result and update the database accordingly\r\n            // this.addViolations(response);\r\n        }.bind(this));\r\n\r\n        this.getModal().on(CustomEvents.events.activate, SELECTORS.MAJOR_FLAG, function (e, data) {\r\n            this.addViolations(2);\r\n        }.bind(this));\r\n\r\n        this.getModal().on(CustomEvents.events.activate, SELECTORS.MINOR_FLAG, function (e, data) {\r\n            this.addViolations(1);\r\n        }.bind(this));\r\n\r\n        this.getModal().on(CustomEvents.events.activate, SELECTORS.CLEAR_FLAG, function (e, data) {\r\n            this.addViolations(-10);\r\n        }.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Override parent show function to update video source\r\n     * \r\n     * @returns {void}\r\n     */\r\n    ModalVideo.prototype.show = function() {\r\n        Modal.prototype.show.call(this);\r\n\r\n        var player = document.getElementById('player');\r\n        player.src = this.webroot + '/mod/quiz/serveproctorvideo.php?stream=true&&attemptid=' + this.attemptID;\r\n\r\n        this.spinner = document.getElementById('loading-spinner');\r\n\r\n        this.getRoot().on(ModalEvents.hidden, function () {\r\n            player.pause();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Set the id of the attempt to pull the video from\r\n     * \r\n     * @param {int} id\r\n     */\r\n    ModalVideo.prototype.setAttemptID = function (id) {\r\n        this.attemptID = id;\r\n    };\r\n\r\n    /**\r\n     * Set the webroot for the server\r\n     * \r\n     * @param {string} webroot \r\n     */\r\n    ModalVideo.prototype.setWebroot = function (webroot) {\r\n        this.webroot = webroot;\r\n    };\r\n\r\n    // Automatically register with the modal registry the first time this module is imported\r\n    if (!registered) {\r\n        ModalRegistry.register(ModalVideo.TYPE, ModalVideo, 'mod_quiz/modal_view_video');\r\n        registered = true;\r\n    }\r\n\r\n    return ModalVideo;\r\n});\r\n"],"file":"modal_view_video.min.js"}