{"version":3,"sources":["../src/modal_quiz_question_bank.js"],"names":["define","$","Y","Notification","Modal","ModalEvents","ModalRegistry","Fragment","registered","SELECTORS","ADD_TO_QUIZ_CONTAINER","ANCHOR","PREVIEW_CONTAINER","SEARCH_OPTIONS","DISPLAY_OPTIONS","ADD_QUESTIONS_FORM","ModalQuizQuestionBank","root","call","contextId","addOnPageId","TYPE","prototype","Object","create","constructor","setContextId","id","getContextId","setAddOnPageId","getAddOnPageId","show","reloadBodyContent","window","location","search","queryString","promise","loadFragment","querystring","fail","exception","setBody","handleAddToQuizEvent","e","anchorElement","href","attr","handlePreviewContainerEvent","openpopup","url","name","options","join","handleDisplayOptionFormEvent","stopPropagation","preventDefault","form","target","closest","serialize","registerDisplayOptionListeners","getModal","on","modifiedElement","bind","registerEventListeners","formElement","currentTarget","appendTo","length","prop","getRoot","bodyRendered","use","M","core_formchangechecker","reset_form_dirty_state","register"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Contain the logic for the question bank modal.\r\n *\r\n * @module     mod_quiz/modal_quiz_question_bank\r\n * @package    mod_quiz\r\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n    'jquery',\r\n    'core/yui',\r\n    'core/notification',\r\n    'core/modal',\r\n    'core/modal_events',\r\n    'core/modal_registry',\r\n    'core/fragment'\r\n],\r\nfunction(\r\n    $,\r\n    Y,\r\n    Notification,\r\n    Modal,\r\n    ModalEvents,\r\n    ModalRegistry,\r\n    Fragment\r\n) {\r\n\r\n    var registered = false;\r\n    var SELECTORS = {\r\n        ADD_TO_QUIZ_CONTAINER: 'td.addtoquizaction',\r\n        ANCHOR: 'a[href]',\r\n        PREVIEW_CONTAINER: 'td.previewaction',\r\n        SEARCH_OPTIONS: '#advancedsearch',\r\n        DISPLAY_OPTIONS: '#displayoptions',\r\n        ADD_QUESTIONS_FORM: 'form[action=\"edit.php\"]',\r\n    };\r\n\r\n    /**\r\n     * Constructor for the Modal.\r\n     *\r\n     * @param {object} root The root jQuery element for the modal\r\n     */\r\n    var ModalQuizQuestionBank = function(root) {\r\n        Modal.call(this, root);\r\n\r\n        this.contextId = null;\r\n        this.addOnPageId = null;\r\n    };\r\n\r\n    ModalQuizQuestionBank.TYPE = 'mod_quiz-quiz-question-bank';\r\n    ModalQuizQuestionBank.prototype = Object.create(Modal.prototype);\r\n    ModalQuizQuestionBank.prototype.constructor = ModalQuizQuestionBank;\r\n\r\n    /**\r\n     * Save the Moodle context id that the question bank is being\r\n     * rendered in.\r\n     *\r\n     * @method setContextId\r\n     * @param {int} id\r\n     */\r\n    ModalQuizQuestionBank.prototype.setContextId = function(id) {\r\n        this.contextId = id;\r\n    };\r\n\r\n    /**\r\n     * Retrieve the saved Moodle context id.\r\n     *\r\n     * @method getContextId\r\n     * @return {int}\r\n     */\r\n    ModalQuizQuestionBank.prototype.getContextId = function() {\r\n        return this.contextId;\r\n    };\r\n\r\n    /**\r\n     * Set the id of the page that the question should be added to\r\n     * when the user clicks the add to quiz link.\r\n     *\r\n     * @method setAddOnPageId\r\n     * @param {int} id\r\n     */\r\n    ModalQuizQuestionBank.prototype.setAddOnPageId = function(id) {\r\n        this.addOnPageId = id;\r\n    };\r\n\r\n    /**\r\n     * Returns the saved page id for the question to be added it.\r\n     *\r\n     * @method getAddOnPageId\r\n     * @return {int}\r\n     */\r\n    ModalQuizQuestionBank.prototype.getAddOnPageId = function() {\r\n        return this.addOnPageId;\r\n    };\r\n\r\n    /**\r\n     * Override the parent show function.\r\n     *\r\n     * Reload the body contents when the modal is shown. The current\r\n     * window URL is used to inform the new content that should be\r\n     * displayed.\r\n     *\r\n     * @method show\r\n     * @return {void}\r\n     */\r\n    ModalQuizQuestionBank.prototype.show = function() {\r\n        this.reloadBodyContent(window.location.search);\r\n        return Modal.prototype.show.call(this);\r\n    };\r\n\r\n    /**\r\n     * Replaces the current body contents with a new version of the question\r\n     * bank.\r\n     *\r\n     * The contents of the question bank are generated using the provided\r\n     * query string.\r\n     *\r\n     * @method reloadBodyContent\r\n     * @param {string} queryString URL encoded string.\r\n     */\r\n    ModalQuizQuestionBank.prototype.reloadBodyContent = function(queryString) {\r\n        // Load the question bank fragment to be displayed in the modal.\r\n        var promise = Fragment.loadFragment(\r\n            'mod_quiz',\r\n            'quiz_question_bank',\r\n            this.getContextId(),\r\n            {\r\n                querystring: queryString\r\n            }\r\n        ).fail(Notification.exception);\r\n\r\n        this.setBody(promise);\r\n    };\r\n\r\n    /**\r\n     * Update the URL of the anchor element that the user clicked on to make\r\n     * sure that the question is added to the correct page.\r\n     *\r\n     * @method handleAddToQuizEvent\r\n     * @param {event} e A JavaScript event\r\n     * @param {object} anchorElement The anchor element that was triggered\r\n     */\r\n    ModalQuizQuestionBank.prototype.handleAddToQuizEvent = function(e, anchorElement) {\r\n        // If the user clicks the plus icon to add the question to the page\r\n        // directly then we need to intercept the click in order to adjust the\r\n        // href and include the correct add on page id before the page is\r\n        // redirected.\r\n        var href = anchorElement.attr('href') + '&addonpage=' + this.getAddOnPageId();\r\n        anchorElement.attr('href', href);\r\n    };\r\n\r\n    /**\r\n     * Open a popup window to show the preview of the question.\r\n     *\r\n     * @method handlePreviewContainerEvent\r\n     * @param {event} e A JavaScript event\r\n     * @param {object} anchorElement The anchor element that was triggered\r\n     */\r\n    ModalQuizQuestionBank.prototype.handlePreviewContainerEvent = function(e, anchorElement) {\r\n        var popupOptions = [\r\n            'height=600',\r\n            'width=800',\r\n            'top=0',\r\n            'left=0',\r\n            'menubar=0',\r\n            'location=0',\r\n            'scrollbars',\r\n            'resizable',\r\n            'toolbar',\r\n            'status',\r\n            'directories=0',\r\n            'fullscreen=0',\r\n            'dependent'\r\n        ];\r\n        window.openpopup(e, {\r\n            url: anchorElement.attr('href'),\r\n            name: 'questionpreview',\r\n            options: popupOptions.join(',')\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Reload the modal body with the new display options the user has selected.\r\n     *\r\n     * A query string is built using the form elements to be used to generate the\r\n     * new body content.\r\n     *\r\n     * @method handleDisplayOptionFormEvent\r\n     * @param {event} e A JavaScript event\r\n     */\r\n    ModalQuizQuestionBank.prototype.handleDisplayOptionFormEvent = function(e) {\r\n        // Stop propagation to prevent other wild event handlers\r\n        // from submitting the form on change.\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\r\n        var form = $(e.target).closest(SELECTORS.DISPLAY_OPTIONS);\r\n        var queryString = '?' + form.serialize();\r\n        this.reloadBodyContent(queryString);\r\n    };\r\n\r\n    /**\r\n     * Listen for changes to the display options form.\r\n     *\r\n     * This handles the user changing:\r\n     *      - The quiz category select box\r\n     *      - The tags to filter by\r\n     *      - Show/hide questions from sub categories\r\n     *      - Show/hide old questions\r\n     *\r\n     * @method registerDisplayOptionListeners\r\n     */\r\n    ModalQuizQuestionBank.prototype.registerDisplayOptionListeners = function() {\r\n        // Listen for changes to the display options form.\r\n        this.getModal().on('change', SELECTORS.DISPLAY_OPTIONS, function(e) {\r\n            // Get the element that was changed.\r\n            var modifiedElement = $(e.target);\r\n            if (modifiedElement.attr('aria-autocomplete')) {\r\n                // If the element that was change is the autocomplete\r\n                // input then we should ignore it because that is for\r\n                // display purposes only.\r\n                return;\r\n            }\r\n\r\n            this.handleDisplayOptionFormEvent(e);\r\n        }.bind(this));\r\n\r\n        // Listen for the display options form submission because the tags\r\n        // filter will submit the form when it is changed.\r\n        this.getModal().on('submit', SELECTORS.DISPLAY_OPTIONS, function(e) {\r\n            this.handleDisplayOptionFormEvent(e);\r\n        }.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Set up all of the event handling for the modal.\r\n     *\r\n     * @method registerEventListeners\r\n     */\r\n    ModalQuizQuestionBank.prototype.registerEventListeners = function() {\r\n        // Apply parent event listeners.\r\n        Modal.prototype.registerEventListeners.call(this);\r\n\r\n        // Set up the event handlers for all of the display options.\r\n        this.registerDisplayOptionListeners();\r\n\r\n        this.getModal().on('submit', SELECTORS.ADD_QUESTIONS_FORM, function(e) {\r\n            // If the user clicks on the \"Add selected questions to the quiz\" button to add some questions to the page\r\n            // then we need to intercept the submit in order to include the correct \"add on page id\" before the form is\r\n            // submitted.\r\n            var formElement = $(e.currentTarget);\r\n\r\n            $('<input />').attr('type', 'hidden')\r\n                .attr('name', \"addonpage\")\r\n                .attr('value', this.getAddOnPageId())\r\n                .appendTo(formElement);\r\n        }.bind(this));\r\n\r\n        this.getModal().on('click', SELECTORS.ANCHOR, function(e) {\r\n            var anchorElement = $(e.currentTarget);\r\n\r\n            // If the anchor element was the add to quiz link.\r\n            if (anchorElement.closest(SELECTORS.ADD_TO_QUIZ_CONTAINER).length) {\r\n                this.handleAddToQuizEvent(e, anchorElement);\r\n                return;\r\n            }\r\n\r\n            // If the anchor element was a preview question link.\r\n            if (anchorElement.closest(SELECTORS.PREVIEW_CONTAINER).length) {\r\n                this.handlePreviewContainerEvent(e, anchorElement);\r\n                return;\r\n            }\r\n\r\n            // Click on expand/collaspse search-options. Has its own handler.\r\n            // We should not interfere.\r\n            if (anchorElement.closest(SELECTORS.SEARCH_OPTIONS).length) {\r\n                return;\r\n            }\r\n\r\n            // Anything else means reload the pop-up contents.\r\n            e.preventDefault();\r\n            this.reloadBodyContent(anchorElement.prop('search'));\r\n        }.bind(this));\r\n\r\n        // Disable the form change checker when the body is rendered.\r\n        this.getRoot().on(ModalEvents.bodyRendered, function() {\r\n            // Make sure the form change checker is disabled otherwise it'll\r\n            // stop the user from navigating away from the page once the modal\r\n            // is hidden.\r\n            Y.use('moodle-core-formchangechecker', function() {\r\n                M.core_formchangechecker.reset_form_dirty_state();\r\n            });\r\n        });\r\n    };\r\n\r\n    // Automatically register with the modal registry the first time this module is\r\n    // imported so that you can create modals of this type using the modal factory.\r\n    if (!registered) {\r\n        ModalRegistry.register(\r\n            ModalQuizQuestionBank.TYPE,\r\n            ModalQuizQuestionBank,\r\n            'core/modal'\r\n        );\r\n\r\n        registered = true;\r\n    }\r\n\r\n    return ModalQuizQuestionBank;\r\n});\r\n"],"file":"modal_quiz_question_bank.min.js"}