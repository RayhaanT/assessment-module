define ("qtype_coderunner/userinterfacewrapper",["jquery","qtype_coderunner/diff","qtype_coderunner/diff2htmlui"],function(a){function b(b,c){var d,e,f=this;this.GUTTER=14;this.MIN_WRAPPER_HEIGHT=50;this.taId=c;this.loadFailId=c+"_loadfailerr";this.textArea=a(document.getElementById(c));e=this.textArea.attr("data-params");if(e){this.templateParams=JSON.parse(e)}else{this.templateParams={}}this.templateParams.lang=this.textArea.attr("data-lang");this.readOnly=this.textArea.prop("readonly");this.isLoading=!1;this.loadFailed=!1;this.retries=0;d=Math.max(parseInt(this.textArea.css("height")),this.MIN_WRAPPER_HEIGHT);this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>");this.textArea.after(this.wrapperNode);this.wrapperNode.hide();this.wrapperNode.css({resize:"vertical",overflow:"hidden",minHeight:d,width:"100%",border:"1px solid darkgrey"});this.textArea.data("current-ui-wrapper",this);this.uiInstance=null;this.loadUi(b,this.templateParams);a(document).mousemove(function(){f.checkForResize()});a(window).resize(function(){f.checkForResize()});this.textArea.closest("form").submit(function(){if(null!==f.uiInstance){f.uiInstance.sync()}});a(document.body).on("keydown",function(a){if(a.keyCode===77&&a.ctrlKey&&a.altKey){if(null!==f.uiInstance||f.loadFailed){f.stop()}else{f.restart()}}})}b.prototype.loadUi=function(b,c){var e=this;function d(b,c){require(["core/str"],function(d){var e=d.get_string(b,"qtype_coderunner"),f=d.get_string("ui_fallback","qtype_coderunner");a.when(e,f).done(function(a,b){c.html(a+"<br>"+b)})})}if(this.isLoading){this.retries+=1;if(20<this.retries){alert("Failed to load "+b+" UI component. If this error persists, please report it to the forum on coderunner.org.nz");this.retries=0;this.loading=0}else{setTimeout(function(){e.loadUi(b,c)},200)}return}this.retries=0;this.params=c;this.stop();this.uiname=b;if(""===this.uiname||"none"===this.uiname||sessionStorage.getItem("disableUis")){this.uiInstance=null}else{this.isLoading=!0;require(["qtype_coderunner/ui_"+this.uiname],function(b){var f,g,i,j,k;j=e.wrapperNode.innerHeight()-e.GUTTER;k=e.wrapperNode.innerWidth();f=new b.Constructor(e.taId,k,j,c);if(f.failed()){e.loadFailed=!0;e.wrapperNode.hide();f.destroy();e.uiInstance=null;e.textArea.addClass("uiloadfailed");g="<div id=\""+e.loadFailId+"\"class=\"uiloadfailed\"></div>";i=a(g);i.insertBefore(e.textArea);d(f.failMessage(),i)}else{e.hLast=0;e.wLast=0;e.textArea.hide();e.wrapperNode.show();e.wrapperNode.append(f.getElement());e.uiInstance=f;e.loadFailed=!1;e.checkForResize()}e.isLoading=!1})}};b.prototype.stop=function(){if(null!==this.uiInstance){this.textArea.show();if(this.uiInstance.hasFocus()){this.textArea.focus();this.textArea[0].selectionStart=this.textArea[0].value.length}this.uiInstance.destroy();this.uiInstance=null;this.wrapperNode.hide()}this.loadFailed=!1;this.textArea.removeClass("uiloadfailed");a(document.getElementById(this.loadFailId)).remove()};b.prototype.restart=function(){if(null===this.uiInstance){this.loadUi(this.uiname,this.params)}};b.prototype.checkForResize=function(){var b,c,d,e,f,g;if(this.uiInstance){b=this.wrapperNode.innerHeight();d=this.wrapperNode.innerWidth();if(b!=this.hLast||d!=this.wLast){f=this.wrapperNode.offset().left;g=a(window).innerWidth()-f-25;c=b-this.GUTTER;e=Math.min(g,d);this.uiInstance.resize(e,c);this.hLast=this.wrapperNode.innerHeight();this.wLast=this.wrapperNode.innerWidth()}}};function c(a,b,c,d){d=d.toLowerCase();if(d.includes("python")){d="python"}var e=document.getElementById(c),f=require("qtype_coderunner/diff"),g=f.createTwoFilesPatch("Browser Submission","Browser Submission",a,b),h=require("qtype_coderunner/diff2htmlui"),i=new h.Diff2HtmlUI(e,g,{inputFormat:"json",drawFileList:!0,matching:"lines",highlight:!0,outputFormat:"side-by-side"});i.draw();e.setAttribute("name","loaded");var j=e.querySelector(".d2h-file-wrapper");j.setAttribute("data-lang",d);i.highlightCode()}function d(a,b,c,d,e,f){f=f.toLowerCase();if(f.includes("python")){f="python"}for(var g=document.getElementById(e),h={inputFormat:"json",drawFileList:!1,matching:"lines",highlight:!0,outputFormat:"side-by-side"},i=require("qtype_coderunner/diff"),j="",k=0;k<b.length;k++){var l=0<k?b[k-1]:a,m=k==b.length-1?"Final submission":"Submission "+(k+1);if(-1==c[k]){m+=": This code caused an error when tests were run"}else{if(c[k]==d){m+=": Passed all tests"}else{m+=": Passed "+c[k]+" out of "+d+" tests"}}j+=i.createTwoFilesPatch(m,m,l,b[k])}var n=require("qtype_coderunner/diff2htmlui"),o=new n.Diff2HtmlUI(g,j,h);o.draw();g.setAttribute("name","loaded");var p=g.querySelector(".d2h-file-wrapper");p.setAttribute("data-lang",f);o.highlightCode()}function e(b,c,e,g,h,i,j,k){var l=a("[id=\""+b+"\"]"),m=a("[id=\""+i+"\"]");m.hide();var n=a("[id=\""+j+"\"]");if("loaded"!=n.attr("name")){d(c,e,g,h,j,k)}else{n.show()}l.on("click",function(){f(b,c,e,g,h,i,j,k)});l.attr("value","Hide intermediate code submissions")}function f(b,d,f,g,h,i,j,k){var l=a("[id=\""+b+"\"]"),m=a("[id=\""+j+"\"]");m.hide();var n=a("[id=\""+i+"\"]");if("loaded"!=n.attr("name")){c(d,f[f.length-1],i,k)}else{n.show()}l.on("click",function(){e(b,d,f,g,h,i,j,k)});l.attr("value","Show all code submissions")}return{newUiWrapper:function(a,c){if(a){return new b(a,c)}else{return null}},diffViewer:c,multiAnswerDiffViewer:d,initDiffToggleButton:function(b,c,d,f,g,h,i,j){var k=a("[id=\""+b+"\"]");k.css({"margin-left":"1em"});k.on("click",function(){e(b,c,d,f,g,h,i,j)})},InterfaceWrapper:b}});
//# sourceMappingURL=userinterfacewrapper.min.js.map
